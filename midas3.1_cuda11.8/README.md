# MiDaS

Uses [MiDaS](https://github.com/isl-org/MiDaS). 

Supports MiDaS 3.1 models and uses CUDA 11.8.

## Quick start

### Inhouse registry

* Log into registry using *public* credentials:

  ```bash
  docker login -u public -p public public.aml-repo.cms.waikato.ac.nz:443 
  ```

* Pull and run image (adjust volume mappings `-v`):

  ```bash
  docker run --gpus=all --shm-size 8G --net=host \
    -v /local/dir:/container/dir \
    -it public.aml-repo.cms.waikato.ac.nz:443/pytorch/midas:3.1_cuda11.8
  ```

### Docker hub

* Pull and run image (adjust volume mappings `-v`):

  ```bash
  docker run --gpus=all --shm-size 8G --net=host \
    -v /local/dir:/container/dir \
    -it waikatodatamining/midas:3.1_cuda11.8
  ```

### Build local image

* Build the image from Docker file (from within /path_to/midas/3.1_cuda11.8)

  ```bash
  docker build -t midas .
  ```
  
* Run the container

  ```bash
  docker run --gpus=all --shm-size 8G --net=host -v /local/dir:/container/dir -it midas
  ```
  `/local/dir:/container/dir` maps a local disk directory into a directory inside the container


## Publish images

### Build

```bash
docker build -t midas:3.1_cuda11.8 .
```

### Inhouse registry  

* Tag

  ```bash
  docker tag \
    midas:3.1_cuda11.8 \
    public-push.aml-repo.cms.waikato.ac.nz:443/pytorch/midas:3.1_cuda11.8
  ```
  
* Push

  ```bash
  docker push public-push.aml-repo.cms.waikato.ac.nz:443/pytorch/midas:3.1_cuda11.8
  ```
  If error "no basic auth credentials" occurs, then run (enter username/password when prompted):
  
  ```bash
  docker login public-push.aml-repo.cms.waikato.ac.nz:443
  ```

### Docker hub  

* Tag

  ```bash
  docker tag \
    midas:3.1_cuda11.8 \
    waikatodatamining/midas:3.1_cuda11.8
  ```
  
* Push

  ```bash
  docker push waikatodatamining/midas:3.1_cuda11.8
  ```
  If error "no basic auth credentials" occurs, then run (enter username/password when prompted):
  
  ```bash
  docker login
  ``` 


### Requirements

```bash
docker run --rm --pull=always \
  -it public.aml-repo.cms.waikato.ac.nz:443/pytorch/midas:3.1_cuda11.8 \
  pip freeze > requirements.txt
```

**NB:** Check for CUDA preamble and remove if necessary.


## Permissions

When running the docker container as regular use, you will want to set the correct
user and group on the files generated by the container (aka the user:group launching
the container):

```bash
docker run -u $(id -u):$(id -g) -e USER=$USER ...
```

## Caching

PaddleSeg will download pretrained models and cache them locally. To avoid having
to download them constantly, you can the cache directory to the host machine:

* when running the container as current user

  ```bash
  -v /some/where/cache:/.cache \
  ```


## Scripts

The following additional scripts are available:

* `midas_run` - for generating predictions of supplied files (calls the `/opt/midas/run.py` script)
* `midas_predict_poll` - for generating predictions of supplied files in batch/poll mode (calls the `/opt/midas/predict_poll.py` script)
* `midas_predict_redis` - for generating predictions via Redis (calls the `/opt/midas/predict_redis.py` script)


## Models

Download the appropriate model to use with the `--model_weights` option.

MiDaS 3.1
- For highest quality: [dpt_beit_large_512](https://github.com/isl-org/MiDaS/releases/download/v3_1/dpt_beit_large_512.pt)
- For moderately less quality, but better speed-performance trade-off: [dpt_swin2_large_384](https://github.com/isl-org/MiDaS/releases/download/v3_1/dpt_swin2_large_384.pt)
- For embedded devices: [dpt_swin2_tiny_256](https://github.com/isl-org/MiDaS/releases/download/v3_1/dpt_swin2_tiny_256.pt), [dpt_levit_224](https://github.com/isl-org/MiDaS/releases/download/v3_1/dpt_levit_224.pt)
- For inference on Intel CPUs, OpenVINO may be used for the small legacy model: openvino_midas_v21_small [.xml](https://github.com/isl-org/MiDaS/releases/download/v3_1/openvino_midas_v21_small_256.xml), [.bin](https://github.com/isl-org/MiDaS/releases/download/v3_1/openvino_midas_v21_small_256.bin)

MiDaS 3.0: Legacy transformer models [dpt_large_384](https://github.com/isl-org/MiDaS/releases/download/v3/dpt_large_384.pt) and [dpt_hybrid_384](https://github.com/isl-org/MiDaS/releases/download/v3/dpt_hybrid_384.pt)

MiDaS 2.1: Legacy convolutional models [midas_v21_384](https://github.com/isl-org/MiDaS/releases/download/v2_1/midas_v21_384.pt) and [midas_v21_small_256](https://github.com/isl-org/MiDaS/releases/download/v2_1/midas_v21_small_256.pt) 
